# Day05_インデックスと性能

---
## 🎯 目次
---

## 1. インデックスとは
インデックス（INDEX）とは、データベース内のデータを効率よく検索するための仕組みです。インデックスを作成することで、特定のカラムを使った検索や並び替えの処理が高速化されます。インデックスは本の索引のような役割を果たし、必要なデータを素早く見つけることができます。
ただし、インデックスを増やしすぎると、データの追加や更新時にインデックスのメンテナンスが必要となり、逆に性能が低下する場合もあります。そのため、どのカラムにインデックスを作成するかは慎重に検討する必要があります。

## 2. インデックスの種類

MSSQL（Microsoft SQL Server）には、主に以下の種類のインデックスがあります。

- **クラスタ化インデックス（Clustered Index）**  
  テーブルのデータそのものがインデックスの順序で並び替えられます。テーブルごとに1つしか作成できません。主キーを設定すると自動的にクラスタ化インデックスが作成されることが多いです。
  - 以下の場合、テーブルの作成時にPRIMARY 制約をつけることで、クラスタ化インデックスが作成されます。
    ```sql
    CREATE TABLE Users (
        user_id INT PRIMARY KEY,
        ...
    );
    ```
- CREATE TABLE時にPRIMARY KEYをつけず、あとから設定することも出来ます。
    ```sql
    -- まず主キーなしでテーブルを作成
    CREATE TABLE Users (
        user_id INT,
        email NVARCHAR(255)
    );

    -- 後からPRIMARY KEYを追加
    ALTER TABLE Users
    ADD CONSTRAINT PK_Users_user_id PRIMARY KEY (user_id);
    ```
- 上記SQLの例の通り、PRIMARY KEYは作らずともテーブルは作成できますが、その場合、「テーブル内で一意に行を特定できるカラムが無い」状態になります。しかし、実務では主キーをつけるのが一般的です。以下のようにすることも出来ます。
    ```sql
    CREATE TABLE Sample (
        col1 INT,
        col2 NVARCHAR(100)
    );

    CREATE CLUSTERED INDEX idx_col1 ON Sample(col1);
    ```
    上記のように、CREATE TABLEで主キーを指定しなくても、CREATE CLUSTERED INDEX文を使えば任意のカラムにクラスタ化インデックスを作成できます。

- では、PRIMARY制約をした場合と、CLUSTERED INDEXにした場合で何が違うのかというと
    1. ADD CONSTRAINT ... PRIMARY KEY
        一意性（UNIQUE）とNOT NULLが自動で保証される
        主キー制約なので、重複やNULL値が許されません。
        論理的な「主キー」として扱われる
        外部キー制約（FOREIGN KEY）で参照できます。
        通常はクラスタ化インデックスが自動で作成される（ただし、既にクラスタ化インデックスがある場合は非クラスタ化になる）
    2. CREATE CLUSTERED INDEX
        一意性やNULLの制約は自動で付与されない
        インデックスなので、重複やNULL値も許されます（UNIQUE指定しない限り）。
        論理的な「主キー」にはならない
        外部キー制約で参照できません。
        単に物理的な並び順を決めるだけ
    3. まとめ
        主キー制約が必要なら ADD CONSTRAINT ... PRIMARY KEY を使う
        単にクラスタ化インデックスだけ作りたい場合は CREATE CLUSTERED INDEX を使う
        両者は「一意性の保証」「NULLの扱い」「外部キー参照可否」などで違いがあります。

- **非クラスタ化インデックス（Non-Clustered Index）**  
  データとは別にインデックス専用の構造が作られます。1つのテーブルに複数作成できます。検索や集計の高速化に利用されます。

- **ユニークインデックス（Unique Index）**  
  インデックス対象のカラムの値が重複しないように制約をかけるインデックスです。重複を防ぎたい場合に利用します。Create Table 時にUNIQUE制約を指定すると、自動的にユニークインデックスが作成されます。
    ```sql
    CREATE TABLE Users (
        user_id INT PRIMARY KEY,
        email NVARCHAR(255) UNIQUE
    );
    ```

- **フィルター付きインデックス（Filtered Index）**  
  特定の条件に合致する行だけを対象にしたインデックスです。部分的なデータに対して効率的な検索が可能です。

- **全文インデックス（Full-Text Index）**  
  文字列データに対して全文検索を行うためのインデックスです。大量のテキストデータからキーワード検索を高速化します。

それぞれのインデックスは用途や目的に応じて使い分けることが重要です。




## 3. インデックスの実例









---

## ✅ 振り返りチェック

- [ ] 基本的な構文を理解した
- [ ] 実行結果を解釈できた
- [ ] 次の内容へつながる疑問が出てきた

---
