# Day07_動的SQL

---

## 🎯 目次
- [1. 動的SQLとは](#1-動的sqlとは)
- [2. 注意点](#2-注意点)
- [3. SQLインジェクションとは](#3-sqlインジェクションとは)
- [4. 設計のアンチパターン](#4-設計のアンチパターン)
- [✅ 振り返りチェック](#-振り返りチェック)
---

## 1. 動的SQLとは

- 動的SQLとは、**実行時にSQL文を組み立てて実行する仕組み**です。
- 通常のSQL（静的SQL）は、あらかじめ決まったSQL文を実行しますが、動的SQLはプログラムやストアドプロシージャ内で文字列としてSQL文を作成し、必要に応じて条件やカラム名・テーブル名などを動的に変更して実行できます。

### 例（SQL Serverの場合）

```sql
DECLARE @sql NVARCHAR(MAX);
SET @sql = N'SELECT * FROM Users WHERE user_name = @name';
EXEC sp_executesql @sql, N'@name NVARCHAR(50)', @name = N'山田';
```

- この例では、変数`@sql`にSQL文を文字列として格納し、`sp_executesql`で実行しています。
- 検索条件やテーブル名などを動的に変更できるため、柔軟なクエリ生成が可能です。

## 2. 注意点

- 動的SQLはSQLインジェクションのリスクがあるため、**必ずパラメータ化**して実行することが重要です。
- 静的SQLよりも可読性や保守性が下がることがあるため、必要な場合のみ使用しましょう。
- 実行計画のキャッシュが効きにくい場合があります。

## 3. SQLインジェクションとは

- **SQLインジェクション**とは、ユーザーからの入力値をそのままSQL文に組み込むことで、悪意のあるSQLコードが実行されてしまう脆弱性のことです。
- たとえば、次のような動的SQLは危険です。

```sql
-- 悪い例（ユーザー入力をそのまま連結）
DECLARE @userName NVARCHAR(50) = N'山田'' OR 1=1 --';
DECLARE @sql NVARCHAR(MAX);
SET @sql = N'SELECT * FROM Users WHERE user_name = ''' + @userName + N'''';
EXEC(@sql);
```

- この場合、`@userName`に「山田' OR 1=1 --」のような値が入ると、WHERE句が常に真となり、全件取得されてしまいます。

### 対策

- **パラメータ化クエリ**を使うことで、ユーザー入力がSQL文として解釈されるのを防げます。

```sql
-- 安全な例（パラメータ化）
DECLARE @sql NVARCHAR(MAX);
SET @sql = N'SELECT * FROM Users WHERE user_name = @name';
EXEC sp_executesql @sql, N'@name NVARCHAR(50)', @name = N'山田';
```

- こうすることで、ユーザー入力が値として扱われ、SQLインジェクションを防ぐことができます。

## 4. 設計のアンチパターン

- 動的SQLを使う際、**テーブル名やカラム名をユーザー入力や外部パラメータとして直接SQL文に組み込むのは絶対に避けるべきアンチパターン**です。

### なぜ危険か

- テーブル名やカラム名はパラメータ化できず、文字列連結でしか組み込めません。
- 悪意のある入力によって、意図しないテーブルやカラムへのアクセス、データ破壊、情報漏洩など重大な被害につながる可能性があります。
- SQLインジェクションのリスクが極めて高くなります。

### 対策

- テーブル名やカラム名は**アプリケーション側で固定**し、ユーザー入力を直接SQL文に組み込まない。
- どうしても可変にしたい場合は、**ホワイトリスト方式**で許可された値のみを選択肢として用意し、入力値を厳格にチェックする。

---

## ✅ 振り返りチェック


---
